---
# Populate Service states
# yamllint disable rule:empty-values
- name: "Get Service States"
  ansible.builtin.service_facts:
  tags:
    - "certbot:post-run"
# yamllint enable rule:empty-values

- name: "Debug"
  ansible.builtin.debug:
    msg: "{{ item }}"
  loop: "{{ certbot_restart_services }}"
  tags:
    - "certbot:post-run"

- name: "Restart Services"
  ansible.builtin.systemd:
    state: "restarted"
    name: "{{ item }}"
  when:
    - "item in ansible_facts['services']"
    - "ansible_facts['services'][item]['state'] == 'running'"
  loop: "{{ certbot_restart_services }}"
  tags:
    - "certbot:post-run"
...
